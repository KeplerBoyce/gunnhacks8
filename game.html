<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="user-scalable=no"/>
        <link href="https://fonts.googleapis.com/css2?family=Oxygen+Mono&family=Oxygen:wght@400;700&display=swap" rel="stylesheet">
        <style>
            html, body {
                height: 100%;
                margin: 0;
                background-color: #fff;
                font-family: oxygen;
            }
            body {
                display: grid;
                grid-template-areas:
                    "t t t"
                    "l l l"
                    "s s s"
                    "r r r"
                    "n n n"
                    "e p o"
                    "m m m"
                    "b b b";
                grid-template-columns: calc(45vw - (min(9vw, 6vh)*5 + 100px)/2) calc(min(9vw, 6vh)*5 + 100px) calc(55vw - (min(9vw, 6vh)*5 + 100px)/2);
                grid-template-rows: 8% 0.3vh 5% 3% 3% 50% 8% 20%;
                touch-action: manipulation;
            }
            #homescreencontainer {
                grid-area: m;
                display: flex;
                justify-content: center;
                align-items: top;
            }
            #homescreen {
                padding: 1vh 1.5vh 0.9vh;
                height: min-content;
                font-size: 2vh;
                font-weight: 700;
                border: none;
                border-radius: 5px;
                background-color: #b64a4a;
                color: #fff;
            }
            #homescreen:hover { filter: brightness(95%); cursor: pointer; }
            #homescreen:active { filter: brightness(85%); }
            #title {
                grid-area: t;
                display: flex;
                justify-content: center;
                font-size: 5vh;
                margin: 10px 0 30px;
            }
            #line {
                grid-area: l;
                margin-left: calc(50vw - 20vh);
                width: 40vh;
                background-color: #d0d0d5;
            }
            #scorecontainer {
                grid-area: s;
                display: grid;
                grid-template-areas:
                    "l c r";
                grid-template-columns: calc(50vw - 5vh) 10vh calc(50vw - 5vh);
            }
            #score {
                grid-area: c;
                display: flex;
                justify-content: center;
                font-size: 3vh;
                margin-top: 1vh;
            }
            #scoreleft {
                grid-area: l;
                display: flex;
                justify-content: right;
                align-items: center;
                font-size: 2.5vh;
                padding-top: 1vh;
            }
            #scoreright {
                grid-area: r;
                display: flex;
                justify-content: left;
                align-items: center;
                font-size: 2.5vh;
                padding-top: 1vh;
            }
            #resulttext {
                grid-area: r;
                display: flex;
                justify-content: center;
                font-size: 1.8vh;
                margin-top: 1vh;
            }
            #nextround {
                grid-area: n;
                display: flex;
                justify-content: center;
                font-size: 1.8vh;
                margin-top: 1vh;
            }
            .container { display: flex; align-items: center; padding: 10px; }
            #player { grid-area: p; justify-content: center; }
            #opponent { grid-area: o; justify-content: left; }
            #keyboard { grid-area: b; justify-content: center; }
            .playerth {
                width: min(9vw, 6vh);
                height: min(9vw, 6vh);
                border: 0.25vh solid #c0c0c5;
                font-size: max(30px, 2.8vh);
                font-weight: 700;
                text-transform: uppercase;
            }
            .opponentth {
                width: min(3vw, 3vh);
                height: min(3vw, 3vh);
                border: 0.25vh solid #c0c0c5;
                color: #fff;
                font-size: max(18px, 1.6vh);
                font-weight: 700;
                text-transform: uppercase;
            }
            #gametable { border-spacing: 0.5vh; }
            #opponenttable { border-spacing: 0.25vh; }
            #keyboardgrid {
                display: grid;
                grid-template-areas:
                    "t"
                    "m"
                    "b";
            }
            .keyboardrow { display: flex; justify-content: center; }
            #toprow { grid-area: t; }
            #middlerow { grid-area: m; }
            #bottomrow { grid-area: b; }
            .keyboardrow > button {
                display: flex;
                justify-content: center;
                align-items: center;
                margin: 0.3vh;
                border: none;
                border-radius: 0.5vh;
                background-color: #d0d0d5;
                font-size: 2vh;
                font-weight: 600;
                -webkit-tap-highlight-color: transparent;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
            #enter { font-size: 1.5vh; }
            #backspace { font-size: 2.5vh; }
            .keyboardrow > button:hover { filter: brightness(95%); cursor: pointer; }
            .keyboardrow > button:active { filter: brightness(85%); }
            .keyboardrow > button:focus { outline: none !important; }
            .smallbutton { width: 4.5vh; height: 6vh; }
            .widebutton { width: 6.9vh; height: 6vh; }
            @media only screen and (max-device-width: 640px) {
                .keyboardrow > button { margin: 0.5vw; }
                .smallbutton { width: 8.5vw; height: min(7vh, 13vw); }
                .widebutton { width: 13vw; height: min(7vh, 13vw); }
                body { grid-template-rows: 8% 0.3vh 5% 3% 3% 50% 5% 25%; }
            }
        </style>
        <script src="/socket.io/socket.io.js"></script>
        <script>
            var socket = io();
            const params = new URLSearchParams(location.search);
            const roomcode = params.get("r");
            const username = params.get("u");
            var answerList = [], guessList = [];
            var row = 0, col = 0;
            var table, opponentTable;
            var answer, numEach;
            var alph = "abcdefghijklmnopqrstuvwxyz";
            var canType = true, lostGame = false;
            window.onload = function() {
                table = document.getElementById('gametable');
                opponentTable = document.getElementById('opponenttable');
                initGrids();
                socket.emit('requestAnswersAndGuesses', {roomcode: roomcode, username: username});
                socket.emit('requestScores', {roomcode: roomcode, username: username});
                var keyElems = document.getElementsByClassName("smallbutton");
                var keyArr = [...keyElems];
                keyArr.forEach(e => {
                    e.addEventListener('mousedown', function() {
                        typeKey(e.id);
                    });
                });
                document.getElementById("enter").addEventListener('mousedown', function(event) {
                    enter();
                });
                document.getElementById("backspace").addEventListener('mousedown', function(event) {
                    backspace();
                });
            }
            setInterval(function() {
                socket.emit('heartbeat', {roomcode: roomcode, username: username});
            }, 1000);
            socket.on('answersAndGuesses', function(data) {
                answerList = data.answers;
                guessList = data.guesses;
                answer = data.answer;
                numEach = new Array(26).fill(0);
                for (var i = 0; i < 5; i++) {
                    numEach[alph.indexOf(answer.charAt(i))]++;
                }
                console.log(answer);
            });
            socket.on('sendColorsToClient', function(data) {
                if (roomcode === data.roomcode && data.opponentName === username) {
                    for (var i = 0; i < 5; i++) {
                        var color = "#fff";
                        switch (data.colors[i]) {
                            case 0: color = "#828282"; break;
                            case 1: color = "#c4b44b"; break;
                            case 2: color = "#71ab67"; break;
                        }
                        opponentTable.rows[data.row].cells[i].style["background-color"] = color;
                    }
                }
            });
            socket.on('opponentWon', function(data) {
                if (data.roomcode === roomcode && data.opponentName === username) {
                    canType = false;
                    var grid = new Array(row);
                    for (i = 0; i <= row; i++) {
                        var gridRow = new Array(5);
                        for (j = 0; j < 5; j++) {
                            gridRow[j] = table.rows[i].cells[j].innerHTML;
                        }
                        grid[i] = gridRow;
                    }
                    socket.emit('fillOpponentGrid', {roomcode: roomcode, username: username, grid: grid});
                    socket.emit('requestScores', {roomcode: roomcode, username: username});
                    document.getElementById('resulttext').innerHTML = "The word was: " + answer.toUpperCase();
                }
            });
            socket.on('transferGrid', function(data) {
                if (data.roomcode === roomcode && data.opponentName === username) {
                    for (var i = 0; i < data.grid.length; i++) {
                        for (var j = 0; j < 5; j++) {
                            opponentTable.rows[i].cells[j].innerHTML = data.grid[i][j];
                        }
                    }
                }
            });
            socket.on('updateScores', function(data) {
                if (data.roomcode == roomcode) {
                    document.getElementById("score").innerHTML = data.leftscore + " - " + data.rightscore;
                    document.getElementById("scoreleft").innerHTML = username;
                    document.getElementById("scoreright").innerHTML = data.opponentName;
                    if (data.leftscore === 5) {
                        document.getElementById('nextround').innerHTML = username + " won the game!";
                    } else if (data.rightscore === 5) {
                        document.getElementById('nextround').innerHTML = data.opponentName + " won the game!";
                    } else if (data.leftscore !== 0 || data.rightscore !== 0) {
                        document.getElementById('nextround').innerHTML = "Next round starting in 5...";
                        nextRoundSequence(data.first === username);
                    }
                }
            });
            socket.on('newAnswer', function(data) {
                if (data.roomcode === roomcode) {
                    answer = data.answer;
                    numEach = new Array(26).fill(0);
                    for (var i = 0; i < 5; i++) {
                        numEach[alph.indexOf(answer.charAt(i))]++;
                    }
                    console.log(answer);
                }
            });
            socket.on('noGuesses', function(data) {
                if (data.roomcode === roomcode && data.opponentName === username
                    && row > 5 && lostGame) {
                    socket.emit('tied', {roomcode: roomcode, username: data.username});
                    document.getElementById("resulttext").innerHTML = "Tied round; the word was: " + answer.toUpperCase();
                    document.getElementById("nextround").innerHTML = "Next round starting in 5...";
                    nextRoundSequence(data.first === username);
                }
            });
            socket.on('tiedGame', function(data) {
                if (data.roomcode === roomcode && data.username === username) {
                    document.getElementById("resulttext").innerHTML = "Tied round; the word was: " + answer.toUpperCase();
                    document.getElementById("nextround").innerHTML = "Next round starting in 5...";
                    nextRoundSequence(data.first === username);
                }
            });
            socket.on('userLeft', function(data) {
                if (data.roomcode === roomcode && data.opponentName === username) {
                    var usr = data.username === undefined ? "Opponent" : data.username;
                    document.getElementById('resulttext').innerHTML = usr + " left the room. Returning to menu in 3...";
                    setTimeout(function() {
                        document.getElementById('resulttext').innerHTML = usr + " left the room. Returning to menu in 2...";
                    setTimeout(function() {
                        document.getElementById('resulttext').innerHTML = usr + " left the room. Returning to menu in 1...";
                    setTimeout(function() {
                        backToMenu();
                    }, 1000);
                    }, 1000);
                    }, 1000);
                }
            });
            socket.on('returnToMainMenu', function(data) {
                if (data.roomcode === roomcode && data.username === username) {
                    location.href = '/?inactive';
                }
            });
            socket.on('forceReturn', function() {
                location.href = '/';
            });
            function initGrids() {
                for (var row = 0; row < 6; row++) {
                    var rowElem = document.createElement('tr');
                    var rowElem2 = document.createElement('tr');
                    for (var col = 0; col < 5; col++) {
                        var boxElem = document.createElement('th');
                        var boxElem2 = document.createElement('th');
                        boxElem.setAttribute("class", "playerth");
                        boxElem2.setAttribute("class", "opponentth");
                        rowElem.appendChild(boxElem);
                        rowElem2.appendChild(boxElem2);
                    }
                    table.appendChild(rowElem);
                    opponentTable.appendChild(rowElem2);
                }
            }
            document.addEventListener('mousemove', function(event) {
                socket.emit('resetTimer', {roomcode: roomcode, username: username});
            });
            document.addEventListener('keydown', function(event) {
                socket.emit('resetTimer', {roomcode: roomcode, username: username});
                var key = String.fromCharCode(event.keyCode).toLowerCase();
                if (alph.indexOf(key) > -1) typeKey(key);
                else if (event.keyCode === 8) backspace();
                else if (event.keyCode === 13) enter();
            });
            function typeKey(letter) {
                if (col < 5 && canType) {
                    table.rows[row].cells[col].innerHTML = letter;
                    col++;
                }
            }
            function backspace() {
                if (col > 0 && canType) {
                    col--;
                    table.rows[row].cells[col].innerHTML = "";
                    for (var i = 0; i < 5; i++) {
                        table.rows[row].cells[i].style.border = "0.25vh solid #c0c0c5";
                    }
                }
            }
            function enter() {
                if (col === 5 && canType) {
                    var guess = "";
                    for (var i = 0; i < 5; i++) {
                        guess += table.rows[row].cells[i].innerHTML;
                    }
                    if (guessList.indexOf(guess) > -1) {
                        guessWord(guess);
                        if (guess === answer) {
                            var grid = new Array(row);
                            for (i = 0; i <= row; i++) {
                                var gridRow = new Array(5);
                                for (j = 0; j < 5; j++) {
                                    gridRow[j] = table.rows[i].cells[j].innerHTML;
                                }
                                grid[i] = gridRow;
                            }
                            socket.emit('fillOpponentGrid', {roomcode: roomcode, username: username, grid: grid});
                            socket.emit('win', {roomcode: roomcode, username: username});
                            socket.emit('requestScores', {roomcode: roomcode, username: username});
                            canType = false;
                            document.getElementById("resulttext").innerHTML = "You found the word!";
                        }
                        row++;
                        col = 0;
                        if (row > 5 && guess !== answer) {
                            canType = false;
                            lostGame = true;
                            document.getElementById('resulttext').innerHTML = "The word was: " + answer.toUpperCase();
                            socket.emit('outOfGuesses', {roomcode: roomcode, username: username});
                        }
                    } else {
                        for (var i = 0; i < 5; i++) {
                            table.rows[row].cells[i].style.border = "0.25vh solid #a67676";
                        }
                    }
                }
            }
            function nextRoundSequence(first) {
                setTimeout(function() {
                    document.getElementById("nextround").innerHTML = "Next round starting in 4...";
                setTimeout(function() {
                    document.getElementById("nextround").innerHTML = "Next round starting in 3...";
                setTimeout(function() {
                    document.getElementById("nextround").innerHTML = "Next round starting in 2...";
                setTimeout(function() {
                    document.getElementById("nextround").innerHTML = "Next round starting in 1...";
                setTimeout(function() {
                    if (first) socket.emit('requestNewAnswer', {roomcode: roomcode, username:username});
                    for (var i = 0; i < 6; i++) {
                        for (var j = 0; j < 5; j++) {
                            table.rows[i].cells[j].innerHTML = "";
                            table.rows[i].cells[j].style.color = "#000";
                            table.rows[i].cells[j].style["background-color"] = "#fff";
                            table.rows[i].cells[j].style.border = "0.25vh solid #c0c0c5";
                            opponentTable.rows[i].cells[j].innerHTML = "";
                            opponentTable.rows[i].cells[j].style["background-color"] = "#fff";
                        }
                    }
                    row = 0;
                    col = 0;
                    var smallKeys = document.getElementsByClassName("smallbutton");
                    var smallKeyArr = [...smallKeys];
                    smallKeyArr.forEach(el => {
                        el.style["background-color"] = "#d0d0d5";
                        el.style.color = "#000";
                    });
                    var wideKeys = document.getElementsByClassName("widebutton");
                    var wideKeyArr = [...wideKeys];
                    wideKeyArr.forEach(el => {
                        el.style["background-color"] = "#d0d0d5";
                        el.style.color = "#000";
                    });
                    document.getElementById("resulttext").innerHTML = "";
                    document.getElementById("nextround").innerHTML = "";
                    canType = true;
                }, 1000);
                }, 1000);
                }, 1000);
                }, 1000);
                }, 1000);
            }
            function guessWord(guess) {
                var yellow = numEach.slice();
                var green = new Array(5).fill(false);
                var colors = [0, 0, 0, 0, 0];
                for (var i = 0; i < 5; i++) {
                    if (answer.charAt(i) === guess.charAt(i)) {
                        green[i] = true;
                        yellow[alph.indexOf(guess.charAt(i))]--;
                    }
                }
                for (var i = 0; i < 5; i++) {
                    var keyElem = document.getElementById(guess.charAt(i));
                    if (green[i]) {
                        table.rows[row].cells[i].style["background-color"] = "#71ab67";
                        colors[i] = 2;
                        keyElem.style["background-color"] = "#71ab67";
                        keyElem.style.color = "#fff";
                    } else if (yellow[alph.indexOf(guess.charAt(i))] > 0) {
                        table.rows[row].cells[i].style["background-color"] = "#c4b44b";
                        yellow[alph.indexOf(guess.charAt(i))]--;
                        colors[i] = 1;
                        if (keyElem.style["background-color"] !== "rgb(113, 171, 103)") {
                            keyElem.style["background-color"] = "#c4b44b";
                        }
                        keyElem.style.color = "#fff";
                    } else {
                        table.rows[row].cells[i].style["background-color"] = "#828282";
                        if (keyElem.style["background-color"] !== "rgb(113, 171, 103)" &&
                            keyElem.style["background-color"] !== "rgb(196, 180, 75)") {
                            keyElem.style["background-color"] = "#828282";
                        }
                        keyElem.style.color = "#fff";
                    }
                    table.rows[row].cells[i].style.color = "#fff";
                }
                socket.emit('sendColorsToServer', {roomcode: roomcode, username: username, colors: colors, row: row});
            }
            function backToMenu() {
                socket.emit('leaveRoom', {roomcode: roomcode, username: username});
                location.href = '/';
            }
        </script>
    </head>
    <body>
        <div id="homescreencontainer">
            <button id="homescreen" onclick="backToMenu()">Leave Room</button>
        </div>
        <div id="title">kwordle</div>
        <div id="line"></div>
        <div id="scorecontainer">
            <div id="scoreleft"></div>
            <div id="score">0 - 0</div>
            <div id="scoreright"></div>
        </div>
        <div id="resulttext"></div>
        <div id="nextround"></div>
        <div class="container" id="player">
            <table id="gametable"></table>
        </div>
        <div class="container" id="opponent">
            <table id="opponenttable"></table>
        </div>
        <div class="container" id="keyboard">
            <div id="keyboardgrid">
                <div class="keyboardrow" id="toprow">
                    <button class="smallbutton" id="q">Q</button>
                    <button class="smallbutton" id="w">W</button>
                    <button class="smallbutton" id="e">E</button>
                    <button class="smallbutton" id="r">R</button>
                    <button class="smallbutton" id="t">T</button>
                    <button class="smallbutton" id="y">Y</button>
                    <button class="smallbutton" id="u">U</button>
                    <button class="smallbutton" id="i">I</button>
                    <button class="smallbutton" id="o">O</button>
                    <button class="smallbutton" id="p">P</button>
                </div>
                <div class="keyboardrow" id="middlerow">
                    <button class="smallbutton" id="a">A</button>
                    <button class="smallbutton" id="s">S</button>
                    <button class="smallbutton" id="d">D</button>
                    <button class="smallbutton" id="f">F</button>
                    <button class="smallbutton" id="g">G</button>
                    <button class="smallbutton" id="h">H</button>
                    <button class="smallbutton" id="j">J</button>
                    <button class="smallbutton" id="k">K</button>
                    <button class="smallbutton" id="l">L</button>
                </div>
                <div class="keyboardrow" id="bottomrow">
                    <button class="widebutton" id="enter">ENTER</button>
                    <button class="smallbutton" id="z">Z</button>
                    <button class="smallbutton" id="x">X</button>
                    <button class="smallbutton" id="c">C</button>
                    <button class="smallbutton" id="v">V</button>
                    <button class="smallbutton" id="b">B</button>
                    <button class="smallbutton" id="n">N</button>
                    <button class="smallbutton" id="m">M</button>
                    <button class="widebutton" id="backspace">âŒ«</button>
                </div>
            </div>
        </div>
    </body>
</html>