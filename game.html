<!DOCTYPE html>
<html>
    <head><link href="https://fonts.googleapis.com/css2?family=Oxygen+Mono&family=Oxygen:wght@400;700&display=swap" rel="stylesheet">
        <style>
            html, body {
                height: 100%;
                margin: 0;
                background-color: #fff;
                font-family: oxygen;
            }
            body {
                display: grid;
                grid-template-areas:
                    "m t a"
                    "l l l"
                    "s s s"
                    "r r r"
                    "n n n"
                    "e p o"
                    "b b b";
                grid-template-columns: calc((100% - 380px)/2) 380px calc((100% - 380px)/2);
                grid-template-rows: 8% 2px 5% 3% 3% 60% 20%;
            }
            #homescreencontainer {
                grid-area: m;
                display: flex;
                justify-content: right;
                align-items: center;
            }
            #homescreen {
                margin: 15px 40px 0 0;
                padding: 6px 10px 5px;
                font-size: 18px;
                border: none;
                border-radius: 5px;
                background-color: #b64a4a;
                color: #fff;
            }
            #homescreen:hover { filter: brightness(85%); cursor: pointer; }
            #title {
                grid-area: t;
                display: flex;
                justify-content: center;
                font-size: 48px;
                margin: 10px 0 30px;
            }
            #line {
                grid-area: l;
                margin-left: 40%;
                width: 20%;
                background-color: #d0d0d5;
            }
            #score {
                grid-area: s;
                display: flex;
                justify-content: center;
                font-size: 30px;
                margin-top: 10px;
            }
            #resulttext {
                grid-area: r;
                display: flex;
                justify-content: center;
                font-size: 18px;
                margin-top: 10px;
            }
            #nextround {
                grid-area: n;
                display: flex;
                justify-content: center;
                font-size: 18px;
                margin-top: 10px;
            }
            .container { display: flex; align-items: center; padding: 10px; }
            #player { grid-area: p; justify-content: center; }
            #opponent { grid-area: o; justify-content: left; }
            #keyboard { grid-area: b; justify-content: center; }
            .playerth {
                width: 60px;
                height: 60px;
                border: 2px solid #c0c0c5;
                font-size: 30px;
                font-weight: 700;
                text-transform: uppercase;
            }
            .opponentth {
                width: 25px;
                height: 25px;
                border: 2px solid #c0c0c5;
                color: #fff;
                font-size: 18px;
                font-weight: 700;
                text-transform: uppercase;
            }
            #gametable { border-spacing: 5px; }
            #opponenttable { border-spacing: 2px; }
            #keyboardgrid {
                display: grid;
                grid-template-areas:
                    "t"
                    "m"
                    "b";
            }
            .keyboardrow { display: flex; justify-content: center; }
            #toprow { grid-area: t; }
            #middlerow { grid-area: m; }
            #bottomrow { grid-area: b; }
            .keyboardrow > button {
                margin: 3px;
                border: none;
                border-radius: 5px;
                background-color: #d0d0d5;
                font-weight: 600;
            }
            .keyboardrow > button:hover {
                filter: brightness(85%);
                cursor: pointer;
            }
            .smallbutton { width: 43px; height: 58px; }
            .widebutton { width: 66px; height: 58px; }
        </style>
        <script src="/socket.io/socket.io.js"></script>
        <script>
            var socket = io();
            var roomcode = location.href.split("?")[1].split("#")[0];
            var username = location.href.split("?")[1].split("#")[1];
            var answerList = [], guessList = [];
            var row = 0, col = 0;
            var table, opponentTable;
            var answer, numEach;
            var alph = "abcdefghijklmnopqrstuvwxyz";
            var canType = true, wonGame = false, lostGame = false;
            window.onload = function() {
                table = document.getElementById('gametable');
                opponentTable = document.getElementById('opponenttable');
                initGrids();
                socket.emit('requestAnswersAndGuesses', {roomcode: roomcode});
                socket.emit('requestScores', {roomcode: roomcode, username: username});
            }
            socket.on('answersAndGuesses', function(data) {
                answerList = data.answers;
                guessList = data.guesses;
                answer = data.answer;
                numEach = new Array(26).fill(0);
                for (var i = 0; i < 5; i++) {
                    numEach[alph.indexOf(answer.charAt(i))]++;
                }
                console.log(answer);
            });
            socket.on('sendColorsToClient', function(data) {
                if (roomcode === data.roomcode && data.opponentName === username) {
                    for (var i = 0; i < 5; i++) {
                        var color = "#fff";
                        switch (data.colors[i]) {
                            case 0: color = "#828282"; break;
                            case 1: color = "#c4b44b"; break;
                            case 2: color = "#71ab67"; break;
                        }
                        opponentTable.rows[data.row].cells[i].style["background-color"] = color;
                    }
                }
            });
            socket.on('opponentWon', function(data) {
                if (data.roomcode === roomcode && data.opponentName === username) {
                    var grid = new Array(row);
                    for (i = 0; i <= row; i++) {
                        var gridRow = new Array(5);
                        for (j = 0; j < 5; j++) {
                            gridRow[j] = table.rows[i].cells[j].innerHTML;
                        }
                        grid[i] = gridRow;
                    }
                    socket.emit('fillOpponentGrid', {roomcode: roomcode, username: username, grid: grid});
                    socket.emit('requestScores', {roomcode: roomcode, username: username});
                    canType = false;
                    document.getElementById('resulttext').innerHTML = "The word was: " + answer.toUpperCase();
                    if (lostGame) document.getElementById('nextround').innerHTML = data.username + " won the game!";
                    else {
                        document.getElementById('nextround').innerHTML = "Next round starting in 5...";
                        nextRoundSequence(false);
                    }
                }
            });
            socket.on('transferGrid', function(data) {
                if (data.roomcode === roomcode && data.opponentName === username) {
                    for (var i = 0; i < data.grid.length; i++) {
                        for (var j = 0; j < 5; j++) {
                            opponentTable.rows[i].cells[j].innerHTML = data.grid[i][j];
                        }
                    }
                }
            });
            socket.on('updateScores', function(data) {
                if (data.roomcode == roomcode) {
                    document.getElementById("score").innerHTML = data.leftscore + " - " + data.rightscore;
                    if (data.leftscore === 4) wonGame = true;
                    else if (data.rightscore === 4) lostGame = true;
                }
            });
            socket.on('newAnswer', function(data) {
                if (data.roomcode === roomcode) {
                    answer = data.answer;
                    console.log(answer);
                }
            });
            socket.on('noGuesses', function(data) {
                if (data.roomcode === roomcode && data.opponentName === username
                    && row > 5 && lostGame) {
                    socket.emit('tied', {roomcode: roomcode, username: data.username});
                    document.getElementById("resulttext").innerHTML = "Tied round; the word was: " + answer;
                    document.getElementById("nextround").innerHTML = "Next round starting in 5...";
                    nextRoundSequence(false);
                }
            });
            socket.on('tiedGame', function(data) {
                if (data.roomcode === roomcode && data.username === username) {
                    document.getElementById("resulttext").innerHTML = "Tied round; the word was: " + answer;
                    document.getElementById("nextround").innerHTML = "Next round starting in 5...";
                    nextRoundSequence(false);
                }
            });
            socket.on('userLeft', function(data) {
                if (data.roomcode === roomcode && data.opponentName === username) {
                    document.getElementById('resulttext').innerHTML = data.username + " left the room. Returning to menu in 3...";
                    setTimeout(function() {
                        document.getElementById('resulttext').innerHTML = data.username + " left the room. Returning to menu in 2...";
                    setTimeout(function() {
                        document.getElementById('resulttext').innerHTML = data.username + " left the room. Returning to menu in 1...";
                    setTimeout(function() {
                        backToMenu();
                    }, 1000);
                    }, 1000);
                    }, 1000);
                }
            });
            function initGrids() {
                for (var row = 0; row < 6; row++) {
                    var rowElem = document.createElement('tr');
                    var rowElem2 = document.createElement('tr');
                    for (var col = 0; col < 5; col++) {
                        var boxElem = document.createElement('th');
                        var boxElem2 = document.createElement('th');
                        boxElem.setAttribute("class", "playerth");
                        boxElem2.setAttribute("class", "opponentth");
                        rowElem.appendChild(boxElem);
                        rowElem2.appendChild(boxElem2);
                    }
                    table.appendChild(rowElem);
                    opponentTable.appendChild(rowElem2);
                }
            }
            function typeKey(letter) {
                if (col < 5 && canType) {
                    table.rows[row].cells[col].innerHTML = letter;
                    col++;
                }
            }
            function backspace() {
                if (col > 0 && canType) {
                    col--;
                    table.rows[row].cells[col].innerHTML = "";
                    for (var i = 0; i < 5; i++) {
                        table.rows[row].cells[i].style.border = "2px solid #ccc";
                    }
                }
            }
            function enter() {
                if (col === 5 && canType) {
                    var guess = "";
                    for (var i = 0; i < 5; i++) {
                        guess += table.rows[row].cells[i].innerHTML;
                    }
                    if (guessList.indexOf(guess) > -1) {
                        guessWord(guess);
                        if (guess === answer) {
                            var grid = new Array(row);
                            for (i = 0; i <= row; i++) {
                                var gridRow = new Array(5);
                                for (j = 0; j < 5; j++) {
                                    gridRow[j] = table.rows[i].cells[j].innerHTML;
                                }
                                grid[i] = gridRow;
                            }
                            socket.emit('fillOpponentGrid', {roomcode: roomcode, username: username, grid: grid});
                            socket.emit('win', {roomcode: roomcode, username: username});
                            socket.emit('requestScores', {roomcode: roomcode, username: username});
                            canType = false;
                            document.getElementById("resulttext").innerHTML = "You found the word!";
                            if (wonGame) document.getElementById('nextround').innerHTML = username + " won the game!";
                            else {
                                document.getElementById('nextround').innerHTML = "Next round starting in 5...";
                                nextRoundSequence(true);
                            }
                        }
                        row++;
                        col = 0;
                        if (row > 5 && guess !== answer) {
                            canType = false;
                            lostGame = true;
                            document.getElementById('resulttext').innerHTML = "The word was: " + answer.toUpperCase();
                            socket.emit('outOfGuesses', {roomcode: roomcode, username: username});
                        }
                    } else {
                        for (var i = 0; i < 5; i++) {
                            table.rows[row].cells[i].style.border = "2px solid #a67676";
                        }
                    }
                }
            }
            function nextRoundSequence(won) {
                setTimeout(function() {
                    document.getElementById("nextround").innerHTML = "Next round starting in 4...";
                setTimeout(function() {
                    document.getElementById("nextround").innerHTML = "Next round starting in 3...";
                setTimeout(function() {
                    document.getElementById("nextround").innerHTML = "Next round starting in 2...";
                setTimeout(function() {
                    document.getElementById("nextround").innerHTML = "Next round starting in 1...";
                setTimeout(function() {
                    if (won) socket.emit('requestNewAnswer', {roomcode: roomcode, username:username});
                    for (var i = 0; i < 6; i++) {
                        for (var j = 0; j < 5; j++) {
                            table.rows[i].cells[j].innerHTML = "";
                            table.rows[i].cells[j].style.color = "#000";
                            table.rows[i].cells[j].style["background-color"] = "#fff";
                            opponentTable.rows[i].cells[j].innerHTML = "";
                            opponentTable.rows[i].cells[j].style["background-color"] = "#fff";
                        }
                    }
                    row = 0;
                    col = 0;
                    var smallKeys = document.getElementsByClassName("smallbutton");
                    var smallKeyArr = [...smallKeys];
                    smallKeyArr.forEach(el => {
                        el.style["background-color"] = "#d0d0d5";
                        el.style.color = "#000";
                    });
                    var wideKeys = document.getElementsByClassName("widebutton");
                    var wideKeyArr = [...wideKeys];
                    wideKeyArr.forEach(el => {
                        el.style["background-color"] = "#d0d0d5";
                        el.style.color = "#000";
                    });
                    document.getElementById("resulttext").innerHTML = "";
                    document.getElementById("nextround").innerHTML = "";
                    canType = true;
                }, 1000);
                }, 1000);
                }, 1000);
                }, 1000);
                }, 1000);
            }
            function guessWord(guess) {
                var yellow = numEach.slice();
                var green = new Array(5).fill(false);
                var colors = [0, 0, 0, 0, 0];
                for (var i = 0; i < 5; i++) {
                    if (answer.charAt(i) === guess.charAt(i)) {
                        green[i] = true;
                        yellow[alph.indexOf(guess.charAt(i))]--;
                    }
                }
                for (var i = 0; i < 5; i++) {
                    var keyElem = document.getElementById(guess.charAt(i));
                    if (green[i]) {
                        table.rows[row].cells[i].style["background-color"] = "#71ab67";
                        colors[i] = 2;
                        keyElem.style["background-color"] = "#71ab67";
                        keyElem.style.color = "#fff";
                    } else if (yellow[alph.indexOf(guess.charAt(i))] > 0) {
                        table.rows[row].cells[i].style["background-color"] = "#c4b44b";
                        yellow[alph.indexOf(guess.charAt(i))]--;
                        colors[i] = 1;
                        if (keyElem.style["background-color"] !== "rgb(113, 171, 103)") {
                            keyElem.style["background-color"] = "#c4b44b";
                        }
                        keyElem.style.color = "#fff";
                    } else {
                        table.rows[row].cells[i].style["background-color"] = "#828282";
                        if (keyElem.style["background-color"] !== "rgb(113, 171, 103)" &&
                            keyElem.style["background-color"] !== "rgb(196, 180, 75)") {
                            keyElem.style["background-color"] = "#828282";
                        }
                        keyElem.style.color = "#fff";
                    }
                    table.rows[row].cells[i].style.color = "#fff";
                }
                socket.emit('sendColorsToServer', {roomcode: roomcode, username: username, colors: colors, row: row});
            }
            function backToMenu() {
                socket.emit('leaveRoom', {roomcode: roomcode, username: username});
                location.href = '/';
            }
        </script>
    </head>
    <body>
        <div id="homescreencontainer">
            <button id="homescreen" onclick="backToMenu()">Leave Room</button>
        </div>
        <div id="title">kwordle</div>
        <div id="line"></div>
        <div id="score">0 - 0</div>
        <div id="resulttext"></div>
        <div id="nextround"></div>
        <div class="container" id="player">
            <table id="gametable"></table>
        </div>
        <div class="container" id="opponent">
            <table id="opponenttable"></table>
        </div>
        <div class="container" id="keyboard">
            <div id="keyboardgrid">
                <div class="keyboardrow" id="toprow">
                    <button class="smallbutton" id="q" onclick="typeKey('q')">Q</button>
                    <button class="smallbutton" id="w" onclick="typeKey('w')">W</button>
                    <button class="smallbutton" id="e" onclick="typeKey('e')">E</button>
                    <button class="smallbutton" id="r" onclick="typeKey('r')">R</button>
                    <button class="smallbutton" id="t" onclick="typeKey('t')">T</button>
                    <button class="smallbutton" id="y" onclick="typeKey('y')">Y</button>
                    <button class="smallbutton" id="u" onclick="typeKey('u')">U</button>
                    <button class="smallbutton" id="i" onclick="typeKey('i')">I</button>
                    <button class="smallbutton" id="o" onclick="typeKey('o')">O</button>
                    <button class="smallbutton" id="p" onclick="typeKey('p')">P</button>
                </div>
                <div class="keyboardrow" id="middlerow">
                    <button class="smallbutton" id="a" onclick="typeKey('a')">A</button>
                    <button class="smallbutton" id="s" onclick="typeKey('s')">S</button>
                    <button class="smallbutton" id="d" onclick="typeKey('d')">D</button>
                    <button class="smallbutton" id="f" onclick="typeKey('f')">F</button>
                    <button class="smallbutton" id="g" onclick="typeKey('g')">G</button>
                    <button class="smallbutton" id="h" onclick="typeKey('h')">H</button>
                    <button class="smallbutton" id="j" onclick="typeKey('j')">J</button>
                    <button class="smallbutton" id="k" onclick="typeKey('k')">K</button>
                    <button class="smallbutton" id="l" onclick="typeKey('l')">L</button>
                </div>
                <div class="keyboardrow" id="bottomrow">
                    <button class="widebutton" id="enter" onclick="enter()">ENTER</button>
                    <button class="smallbutton" id="z" onclick="typeKey('z')">Z</button>
                    <button class="smallbutton" id="x" onclick="typeKey('x')">X</button>
                    <button class="smallbutton" id="c" onclick="typeKey('c')">C</button>
                    <button class="smallbutton" id="v" onclick="typeKey('v')">V</button>
                    <button class="smallbutton" id="b" onclick="typeKey('b')">B</button>
                    <button class="smallbutton" id="n" onclick="typeKey('n')">N</button>
                    <button class="smallbutton" id="m" onclick="typeKey('m')">M</button>
                    <button class="widebutton" id="backspace" onclick="backspace()">⌫</button>
                </div>
            </div>
        </div>
    </body>
</html>