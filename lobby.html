<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="user-scalable=no"/>
        <link href="https://fonts.googleapis.com/css2?family=Oxygen+Mono&family=Oxygen:wght@400;700&display=swap" rel="stylesheet">
        <style>
            html, body {
                height: 100%;
                margin: 0;
                background-color: #fff;
                font-family: oxygen;
            }
            body { touch-action: manipulation; }
            #outer {
                height: 70%;
                align-items: center;
                display: flex;
            }
            #inner {
                width: 100%;
                margin: auto;
                text-align: center;
                vertical-align: middle;
                border-radius: max(25px, 2.2vh);
            }
            #title { font-size: max(60px, 6vh); margin-bottom: 20px; }
            #roomcode { font-size: max(40px, 4vh); margin-bottom: 10px; }
            #send { font-size: max(20px, 1.8vh); margin-bottom: 30px; }
            #wait { font-size: max(20px, 1.8vh); margin-bottom: 10px; }
            #start {
                padding: max(8px, 0.8vh) max(12px, 1.2vh);
                border: none;
                border-radius: max(5px, 0.5vh);
                font-size: max(20px, 1.8vh);
                font-weight: 700;
                background-color: #ddd;
                color: #aaa;
            }
            #start:hover { filter: brightness(95%); cursor: pointer; }
            #start:active { filter: brightness(85%); }
            @media only screen and (max-device-width: 640px) {
                #title { font-size: 8vh; margin-bottom: 2.5vh; }
                #roomcode { font-size: 5vh; margin-bottom: 1vh; }
                #send { font-size: 3vh; margin-bottom: 4vh; }
                #wait { font-size: 3vh; margin-bottom: 1.5vh; }
                #start {
                    padding: 1vh 1.5vh;
                    margin: 1vh 0.2vh 0;
                    border-radius: 0.5vh;
                    font-size: 3vh;
                    background-color: #ddd;
                    color: #aaa;
                }
            }
        </style>
        <script src="/socket.io/socket.io.js"></script>
        <script>
            var socket = io();
            const params = new URLSearchParams(location.search);
            const roomcode = params.get("r");
            const username = params.get("u");
            var opponentName;
            var id;
            var hasOpponent = false;
            window.onload = function() {
                document.getElementById("roomcode").innerHTML = "Room code: " + roomcode;
                socket.emit('requestId', {roomcode: roomcode, username: username});
                socket.emit('requestOpponentName', {roomcode: roomcode, username: username})
            }
            setInterval(function() {
                socket.emit('heartbeat', {roomcode: roomcode, username: username});
            }, 1000);
            socket.on('returnId', function(data) {
                id = data.idValue;
            });
            socket.on('returnOpponentName', function(data) {
                opponentName = data.opponentName;
                setWaitElement();
            });
            socket.on("opponentJoin", function(data) {
                if (data.idValue === id) {
                    opponentName = data.username;
                    setWaitElement();
                }
            });
            socket.on('opponentDisconnect', function(data) {
                console.log("a");
                if (data.roomcode === roomcode) {
                    console.log("b");
                    unsetWaitElement(data.username);
                }
            });
            socket.on('startGame', function(data) {
                if (data.idValue === id) {
                    play(false);
                }
            });
            socket.on('returnToMainMenu', function(data) {
                if (data.roomcode === roomcode && data.username === username) {
                    location.href = '/?inactive';
                }
            });
            socket.on('forceReturn', function() {
                location.href = '/';
            });
            document.addEventListener('mousemove', function(event) {
                socket.emit('resetTimer', {roomcode: roomcode, username: username});
            });
            function setWaitElement() {
                document.getElementById("wait").innerHTML = "Playing against " + opponentName;
                document.getElementById('start').style["background-color"] = "#44b457";
                document.getElementById('start').style.color = "#fff";
                hasOpponent = true;
            }
            function unsetWaitElement(usr) {
                opponentName = "";
                document.getElementById("wait").innerHTML = usr + " disconnected. Waiting for an opponent to join...";
                document.getElementById('start').style["background-color"] = "#ddd";
                document.getElementById('start').style.color = "#aaa";
                hasOpponent = false;
            }
            function play(first) {
                if (hasOpponent) {
                    if (first) socket.emit('startOpponentGame', {roomcode: roomcode, username: opponentName});
                    location.href = "game.html?r=" + roomcode + "&u=" + username;
                }
            }
        </script>
    </head>
    <body>
        <div id="outer">
            <div id="inner">
                <header id="title">kwordle</header>
                <div id="roomcode">Room code:</div>
                <div id="send">Send the room code to a friend!</div>
                <div id="wait">Waiting for an opponent to join...</div>
                <button id="start" onclick="play(true)">Start Game</button>
            </div>
        </div>
    </body>
</html>